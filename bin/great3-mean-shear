#!/usr/bin/env python
"""
    %prog [options] config_file cuts_config_file [outfile]

If outfile is not sent, print to stdout
"""
from __future__ import print_function

import sys
import yaml

import great3
from great3 import files

from optparse import OptionParser
parser=OptionParser(__doc__)

def do_calc_mean_shear(conf, cuts, subid):
    """
    Read the data and calculate the mean shear according
    the the run type
    """
    conf['subid']=subid
    data=files.read_output(**conf)

    if 'rg' in conf['run']:
        res=great3.rg.select_and_calc_shear(data, **cuts)
    else:
        raise ValueError("unsupported run type: '%s'" % conf['run'])

    return res

def main():
    options,args = parser.parse_args(sys.argv[1:])

    if len(args) < 2:
        parser.print_help()
        sys.exit(45)

    config_file=args[0]
    cuts_config=args[1]

    if len(args) > 2:
        fobj=open(args[2],'w')
    else:
        fobj=sys.stdout

    conf=yaml.load(open(config_file))
    cuts=yaml.load(open(cuts_config))

    nsub=files.get_nsub(**conf)

    conf['cut'] = cuts['cut']
    outname=files.get_shear_file(**conf)
    print("writing to output file:",outname)

    with open(outname,'w') as fobj:
        for subid in xrange(nsub):
            res=do_calc_mean_shear(conf, cuts, subid)
            out=(subid, res['shear'][0], res['shear'][1])
            fobj.write('%d %.16g %.16g\n' % out)

    print("output in:",outname)

main()
